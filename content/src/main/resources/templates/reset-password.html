<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head><title>비밀번호 재설정</title></head>
<body>
<div layout:fragment="content">
    <div class="auth-layout">
        <div class="auth-box">
            <h1>새 비밀번호 설정</h1>
            <div id="errorMsg" class="error-message"></div>
            <div id="successMsg" class="success-message"></div>
            <div class="form-group">
                <input type="password" id="newPassword" placeholder="새 비밀번호">
            </div>
            <div class="form-group">
                <input type="password" id="confirmPassword" placeholder="비밀번호 확인">
            </div>
            <button class="btn btn-primary" onclick="resetPassword()">비밀번호 재설정</button>
        </div>
    </div>
    <script>
    async function resetPassword() {
        var newPassword = document.getElementById('newPassword').value;
        var confirmPassword = document.getElementById('confirmPassword').value;
        var errorEl = document.getElementById('errorMsg');
        var successEl = document.getElementById('successMsg');
        errorEl.style.display = 'none';
        successEl.style.display = 'none';

        if (!newPassword || newPassword.length < 4) {
            errorEl.textContent = '비밀번호는 최소 4자 이상이어야 합니다';
            errorEl.style.display = 'block';
            return;
        }
        if (newPassword !== confirmPassword) {
            errorEl.textContent = '비밀번호가 일치하지 않습니다';
            errorEl.style.display = 'block';
            return;
        }

        var params = new URLSearchParams(window.location.search);
        var token = params.get('token');
        if (!token) {
            errorEl.textContent = '유효하지 않은 재설정 링크입니다';
            errorEl.style.display = 'block';
            return;
        }

        try {
            var res = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, newPassword: newPassword })
            });
            if (res.ok) {
                successEl.textContent = '비밀번호가 성공적으로 재설정되었습니다. 로그인 페이지로 이동합니다...';
                successEl.style.display = 'block';
                setTimeout(function() { window.location.href = '/login'; }, 2000);
            } else {
                var data = await res.json().catch(function() { return null; });
                errorEl.textContent = (data && data.message) || '재설정 실패';
                errorEl.style.display = 'block';
            }
        } catch (e) {
            errorEl.textContent = '서버 오류';
            errorEl.style.display = 'block';
        }
    }
    </script>
</div>
</body>
</html>
